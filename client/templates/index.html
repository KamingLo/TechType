<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Race TCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 font-mono">

    <div id="username-section" class="w-full max-w-md bg-gray-800 rounded-lg shadow-xl p-8 border border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-400 tracking-wider">TYPING RACE</h1>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">Username</label>
            <input type="text" id="username" class="w-full px-4 py-3 bg-gray-700 rounded border border-gray-600 text-white focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Masukkan nama...">
        </div>
        <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded transition-all transform hover:scale-105">MASUK ARENA</button>
    </div>
    
    <div id="main-layout" class="hidden w-full max-w-6xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-gray-800 rounded-lg border border-gray-700 p-8 h-[85vh] flex flex-col relative shadow-lg overflow-hidden">
            
            <div id="connection-alert" class="hidden absolute top-0 left-0 w-full bg-red-900/90 border-b border-red-500 p-3 flex items-center justify-between z-50 fade-in">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üîå</span>
                    <span class="text-red-100 font-bold text-sm">Koneksi ke Server Terputus.</span>
                </div>
                <button onclick="window.location.reload()" class="bg-red-700 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition-colors border border-red-500">
                    Reconnect
                </button>
            </div>

            <div id="game-menu" class="flex flex-col items-center justify-center h-full">
                <h2 class="text-3xl mb-2 font-bold">Halo, <span id="display-username" class="text-indigo-400">Player</span></h2>
                <p class="text-gray-400 mb-8">Siap menguji kecepatan jarimu?</p>
                <button id="play-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transition-all transform hover:scale-105 flex items-center">
                    <span>‚öîÔ∏è CARI LAWAN</span>
                </button>
            </div>
            
            <div id="game-loading" class="hidden flex flex-col items-center justify-center h-full">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-6"></div>
                <h2 class="text-2xl font-bold text-yellow-400 mb-2">Mencari Lawan...</h2>
                <p class="text-gray-300">Pemain dalam antrian: <span id="queue-count" class="font-bold text-white text-xl">0</span></p>
                <p id="loading-msg" class="text-gray-500 text-sm mt-4 animate-pulse">Menunggu koneksi...</p>
            </div>
            
            <div id="game-play" class="hidden h-full flex flex-col relative">
                
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 px-6 py-2 rounded-b-lg border-b border-x border-gray-600 shadow-lg z-10">
                    <div class="text-2xl font-bold text-yellow-400 tracking-widest flex items-center gap-2">
                        <span>‚è±Ô∏è</span> <span id="timer-display">00:00</span>
                    </div>
                </div>

                <div id="countdown" class="absolute inset-0 flex items-center justify-center bg-gray-900/90 z-50 text-9xl font-bold text-yellow-400 hidden rounded-lg">3</div>
                
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-600 shadow-inner mb-4 mt-6">
                    
                    <div class="flex flex-col mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-red-400 font-bold flex items-center">
                                üòà LAWAN: <span id="opp-name" class="ml-1 text-white">...</span>
                            </span>
                            <div class="flex gap-3 text-sm">
                                <span class="text-gray-400"><span id="opp-wpm" class="text-white font-bold text-base">0</span> WPM</span>
                                <span class="text-red-400 font-bold text-base w-12 text-right" id="opp-percent">0%</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div id="opp-progress-bar" class="bg-red-500 h-full transition-all duration-300 shadow-[0_0_10px_rgba(239,68,68,0.7)]" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-green-400 font-bold flex items-center">
                                üë§ SAYA (<span id="my-name-hud">You</span>)
                            </span>
                            <div class="flex gap-3 text-sm">
                                <span class="text-gray-400"><span id="my-wpm" class="text-white font-bold text-base">0</span> WPM</span>
                                <span class="text-green-400 font-bold text-base w-12 text-right" id="my-percent">0%</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div id="my-progress-bar" class="bg-green-500 h-full transition-all duration-100 shadow-[0_0_10px_rgba(34,197,94,0.7)]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-grow bg-gray-700 p-6 rounded-lg mb-4 overflow-auto border border-gray-600 shadow-inner no-select cursor-default" oncontextmenu="return false;">
                    <p id="text-target" class="text-xl leading-loose font-mono text-gray-300"></p>
                </div>
                
                <div>
                    <input type="text" id="typing-input" 
                           class="w-full bg-gray-900 border-2 border-gray-500 p-4 rounded-lg text-white text-lg focus:border-green-500 focus:outline-none transition-all placeholder-gray-600" 
                           placeholder="Ketik teks di atas secepat mungkin..." 
                           disabled 
                           autocomplete="off"
                           onpaste="return false;"
                           ondrop="return false;">
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 bg-gray-800 rounded-lg border border-gray-700 p-6 h-[85vh] flex flex-col shadow-lg">
            <h2 class="text-xl font-bold text-yellow-400 mb-4 border-b border-gray-600 pb-2 flex items-center">
                <span class="mr-2">üèÜ</span> LEADERBOARD
            </h2>
            <ul id="leaderboard-list" class="space-y-2 overflow-y-auto pr-2 custom-scrollbar">
                <li class="text-gray-500 text-center italic mt-10">Menghubungkan...</li>
            </ul>
        </div>
    </div>
    
    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let ws;
        let username = '';
        let targetText = '';
        let startTime = 0;
        let timerInterval = null;
        let wpmUpdateInterval = null;
    
        const els = {
            alertBar: document.getElementById('connection-alert'),
            loginSec: document.getElementById('username-section'),
            mainLayout: document.getElementById('main-layout'),
            menuState: document.getElementById('game-menu'),
            loadingState: document.getElementById('game-loading'),
            playState: document.getElementById('game-play'),
            inputUser: document.getElementById('username'),
            btnStart: document.getElementById('start-btn'),
            inputTyping: document.getElementById('typing-input'),
            btnPlay: document.getElementById('play-btn'),
            queueCount: document.getElementById('queue-count'),
            loadingMsg: document.getElementById('loading-msg'),
            textDisplay: document.getElementById('text-target'),
            leaderboard: document.getElementById('leaderboard-list'),
            countdown: document.getElementById('countdown'),
            displayName: document.getElementById('display-username'),
            myNameHud: document.getElementById('my-name-hud'),
            myWpm: document.getElementById('my-wpm'),
            myBar: document.getElementById('my-progress-bar'),
            myPercent: document.getElementById('my-percent'),
            oppName: document.getElementById('opp-name'),
            oppBar: document.getElementById('opp-progress-bar'),
            oppPercent: document.getElementById('opp-percent'),
            oppWpm: document.getElementById('opp-wpm'),
            timerDisplay: document.getElementById('timer-display')
        };

        els.btnStart.onclick = () => {
            username = els.inputUser.value.trim();
            if(!username) return alert("Username tidak boleh kosong!");
            els.loginSec.classList.add('hidden');
            els.mainLayout.classList.remove('hidden');
            els.displayName.textContent = username;
            els.myNameHud.textContent = username;
            initSocket();
        };

        els.btnPlay.onclick = () => {
            switchState('loading');
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "req_matchmaking" }));
            }
        };

        function getLocalIPs(callback){
            let ips = []
            let pc = new RTCPeerConnection({iceServers: [{urls: "stun:stun.l.google.com:19302"}]});

            pc.createDataChannel("dummy");

            pc.onicecandidate = (event) => {
                if(!event || !event.candidate) return;
                let candidate = event.candidate.candidate;

                // ambil ip forward ipv4
                let ipMatch = candidate.match(/(\d{1,3}\.){3}\d{1,3}/);
                if (!ipMatch) return;

                let ip = ipMatch[0];

                if (!ips.includes(ip)) {
                    ips.push(ip);
                }
            };

            pc.createOffer()
                .then(o => pc.setLocalDescription(o))
                .catch(err => console.error(err));

            setTimeout(() => callback(ips), 1000)

        };

        function initSocket() {
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/stream/${username}`);
            
            ws.onopen = () => {
                getLocalIPs((ip) => {
				    ws.send(JSON.stringify({
				    	type: "client_ip",
					    ip: ip
				    }));

                        console.log(ip);
			    })
                console.log("WebSocket Connected");
                els.alertBar.classList.add('hidden'); 
            };
            
            ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
            
            ws.onclose = (e) => {
                console.warn("WebSocket Closed:", e);
                showConnectionError();
            };

            ws.onerror = (e) => {
                console.error("WebSocket Error:", e);
                showConnectionError();
            };
        }

        function showConnectionError() {
            els.alertBar.classList.remove('hidden');
            els.inputTyping.disabled = true;
            stopTimer();
        }

        function handleMessage(msg) {
            if (msg.type === 'res_leaderboard' || msg.type === 'leaderboard_update') {
                renderLeaderboard(msg.data || msg.leaderboard);
            }
            else if (msg.status === 'waiting') {
                els.queueCount.textContent = msg.waiting_count || 1;
                els.loadingMsg.textContent = msg.message;
            }
            else if (msg.status === 'matched') {
                els.loadingMsg.textContent = "Lawan ditemukan!";
                els.oppName.textContent = msg.opponent;
                setTimeout(() => switchState('play'), 500);
            }
            else if (msg.type === 'countdown') {
                els.countdown.classList.remove('hidden');
                els.countdown.textContent = msg.value;
            }
            else if (msg.type === 'start_game') {
                els.countdown.textContent = "GO!";
                targetText = msg.text;
                startTimer(msg.duration || 90); 
                startGameLogic();
                setTimeout(() => els.countdown.classList.add('hidden'), 1000);
            }
            else if (msg.type === 'opponent_progress') {
                const prog = Math.round(msg.progress || 0);
                const wpm = msg.wpm || 0;
                els.oppBar.style.width = `${prog}%`;
                els.oppPercent.textContent = `${prog}%`;
                els.oppWpm.textContent = wpm;
            }
            else if (msg.type === 'game_over') {
                endGameLogic(msg);
            }
            else if (msg.status === 'opponent_disconnected') {
                alert("Lawan terputus!");
                resetGameUI();
            }
        }

        function switchState(state) {
            els.menuState.classList.add('hidden');
            els.loadingState.classList.add('hidden');
            els.playState.classList.add('hidden');

            if (state === 'menu') els.menuState.classList.remove('hidden');
            if (state === 'loading') els.loadingState.classList.remove('hidden');
            if (state === 'play') els.playState.classList.remove('hidden');
        }

        function startTimer(durationSeconds) {
            clearInterval(timerInterval); 
            let timeLeft = durationSeconds;
            updateTimerDisplay(timeLeft);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    els.inputTyping.disabled = true; 
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            clearInterval(wpmUpdateInterval); 
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            els.timerDisplay.textContent = `${m}:${s}`;
            if(seconds <= 10) els.timerDisplay.parentElement.classList.add('text-red-500');
            else els.timerDisplay.parentElement.classList.remove('text-red-500');
        }

        function startGameLogic() {
            renderText();
            els.inputTyping.disabled = false;
            els.inputTyping.value = '';
            els.inputTyping.focus();
            
            els.myBar.style.width = '0%';
            els.myPercent.textContent = '0%';
            els.myWpm.textContent = '0';
            
            els.oppBar.style.width = '0%';
            els.oppPercent.textContent = '0%';
            els.oppWpm.textContent = '0';
            
            startTime = Date.now();

            clearInterval(wpmUpdateInterval);
            wpmUpdateInterval = setInterval(() => {
                if (!els.inputTyping.disabled) {
                    updateStats(false); 
                }
            }, 1000);
        }

        function endGameLogic(msg) {
            stopTimer();
            els.inputTyping.disabled = true;
            els.countdown.classList.remove('hidden');
            
            let mainText = "";
            let subText = "";

            if (msg.reason === "timeout") {
                mainText = `<span class="text-orange-500 text-5xl">WAKTU HABIS!</span>`;
                if (msg.result === 'won') subText = "Kamu Menang (Progress Lebih Jauh)";
                else if (msg.result === 'lost') subText = "Kamu Kalah (Lawan Lebih Jauh)";
                else subText = "SERI (Progress Sama)";
            } else {
                mainText = msg.result === 'won' 
                    ? '<span class="text-green-500 text-6xl">MENANG!</span>' 
                    : '<span class="text-red-500 text-6xl">KALAH!</span>';
            }
                
            els.countdown.innerHTML = `
                <div class="text-center bg-gray-900 p-10 rounded-xl border border-gray-600">
                    ${mainText}<br>
                    <div class="text-xl text-gray-300 mt-2">${subText}</div>
                    <div class="text-2xl text-white mt-4 font-mono">Final Speed: ${msg.wpm} WPM</div>
                </div>`;
            
            if(msg.leaderboard) renderLeaderboard(msg.leaderboard);

            setTimeout(() => {
                els.countdown.classList.add('hidden');
                resetGameUI();
            }, 5000);
        }

        function resetGameUI() {
            stopTimer();
            switchState('menu');
            els.queueCount.textContent = '0';
            els.inputTyping.value = '';
        }

        function renderLeaderboard(data) {
            if (!data) return;
            els.leaderboard.innerHTML = '';
            data.forEach((d, i) => {
                const li = document.createElement('li');
                let rankColor = "text-gray-400";
                if (i === 0) rankColor = "text-yellow-400";
                if (i === 1) rankColor = "text-gray-300";
                if (i === 2) rankColor = "text-orange-400";

                li.className = "flex justify-between items-center bg-gray-700/50 p-3 rounded hover:bg-gray-700 transition-colors";
                li.innerHTML = `
                    <div>
                        <span class="font-bold mr-3 ${rankColor}">#${i+1}</span>
                        <span class="font-semibold text-white">${d.username}</span>
                    </div>
                    <span class="font-mono text-indigo-300 font-bold">${d.wpm} WPM</span>
                `;
                els.leaderboard.appendChild(li);
            });
        }

        function renderText() {
            els.textDisplay.innerHTML = '';
            const input = els.inputTyping.value;
            targetText.split('').forEach((char, i) => {
                const span = document.createElement('span');
                span.textContent = char;
                if (i < input.length) {
                    span.className = input[i] === char 
                        ? "text-green-400 border-b-2 border-green-500" 
                        : "text-red-400 bg-red-900/50 border-b-2 border-red-500";
                } else {
                    span.className = "text-gray-500";
                }
                els.textDisplay.appendChild(span);
            });
        }

        function updateStats(checkFinish = true) {
            const inputVal = els.inputTyping.value;
            const targetVal = targetText;
            
            const inputWords = inputVal.split(' ');
            const targetWords = targetVal.split(' ');
            
            let correctCharsFromWords = 0;
            
            for (let i = 0; i < inputWords.length; i++) {
                if (i >= targetWords.length) break;
                
                const currentInputWord = inputWords[i];
                const currentTargetWord = targetWords[i];
                
                if (currentInputWord === currentTargetWord) {
                    correctCharsFromWords += currentInputWord.length;
                    
                    const isLastWord = (i === inputWords.length - 1);
                    const hasTrailingSpace = inputVal.endsWith(' ');
                    
                    if (!isLastWord || (isLastWord && hasTrailingSpace)) {
                         if (i < targetWords.length - 1) {
                             correctCharsFromWords++; 
                         }
                    }
                }
            }

            const elapsedMinutes = Math.max((Date.now() - startTime) / 60000, 0.0001);
            const wpm = Math.round((correctCharsFromWords / 5) / elapsedMinutes);
            
            const progress = Math.min(100, (correctCharsFromWords / targetText.length) * 100);
            const progressInt = Math.floor(progress);

            els.myWpm.textContent = wpm;
            els.myBar.style.width = `${progress}%`;
            els.myPercent.textContent = `${progressInt}%`;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "progress",
                    progress: progress,
                    wpm: wpm
                }));
            }

            if (checkFinish && inputVal === targetText) {
                ws.send(JSON.stringify({ type: "finish", wpm: wpm }));
                els.inputTyping.disabled = true;
                clearInterval(wpmUpdateInterval); 
            }
        }
        
        els.inputTyping.addEventListener('paste', (e) => e.preventDefault());
        
        els.inputTyping.oninput = () => {
            renderText(); 
            updateStats(true); 
        };
    </script>
</body>
</html>
